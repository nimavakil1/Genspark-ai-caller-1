<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title || 'AI Sales Dashboard' %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --sidebar-bg: #2c3e50;
            --sidebar-active: #3498db;
        }

        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .sidebar {
            background: linear-gradient(180deg, var(--sidebar-bg) 0%, #34495e 100%);
            min-height: 100vh;
            width: 250px;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .sidebar-header h4 {
            color: white;
            margin: 0;
            font-size: 1.2rem;
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 1rem 0;
        }

        .sidebar-menu li {
            margin: 0;
        }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border-left-color: var(--sidebar-active);
        }

        .sidebar-menu i {
            width: 20px;
            margin-right: 10px;
            text-align: center;
        }

        .main-content {
            margin-left: 250px;
            padding: 0;
            transition: margin-left 0.3s ease;
        }

        .main-content.expanded {
            margin-left: 0;
        }

        .top-navbar {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1rem 2rem;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .content-area {
            padding: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary-color);
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-card.success {
            border-left-color: var(--success-color);
        }

        .stat-card.warning {
            border-left-color: var(--warning-color);
        }

        .stat-card.danger {
            border-left-color: var(--danger-color);
        }

        .stat-card.info {
            border-left-color: var(--info-color);
        }

        .stat-icon {
            font-size: 2.5rem;
            opacity: 0.8;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            border: none;
            border-radius: 8px;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .card-header {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 10px 10px 0 0 !important;
            border: none;
        }

        .table th {
            border-top: none;
            background-color: #f8f9fa;
            font-weight: 600;
        }

        .badge {
            font-size: 0.75rem;
            padding: 0.4em 0.8em;
        }

        .modal-content {
            border: none;
            border-radius: 15px;
        }

        .modal-header {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 15px 15px 0 0;
        }

        .form-control, .form-select {
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .sidebar-toggle {
            display: none;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .sidebar-toggle {
                display: inline-block;
            }
            
            .content-area {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h4><i class="fas fa-phone-volume me-2"></i>AI Sales</h4>
            <small class="text-light">Receipt Roll System</small>
        </div>
        <ul class="sidebar-menu">
            <li><a href="#" class="nav-link active" data-section="overview"><i class="fas fa-chart-pie"></i>Overview</a></li>
            <li><a href="#" class="nav-link" data-section="customers"><i class="fas fa-users"></i>Customers</a></li>
            <li><a href="#" class="nav-link" data-section="calls"><i class="fas fa-phone"></i>Calls</a></li>
            <li><a href="#" class="nav-link" data-section="products"><i class="fas fa-box"></i>Products</a></li>
            <li><a href="#" class="nav-link" data-section="orders"><i class="fas fa-shopping-cart"></i>Orders</a></li>
            <li><a href="#" class="nav-link" data-section="analytics"><i class="fas fa-chart-line"></i>Analytics</a></li>
            <li><a href="#" class="nav-link" data-section="settings"><i class="fas fa-cog"></i>Settings</a></li>
        </ul>
        <div class="mt-auto p-3">
            <button class="btn btn-outline-light btn-sm w-100" onclick="logout()">
                <i class="fas fa-sign-out-alt me-2"></i>Logout
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Top Navigation -->
        <nav class="top-navbar">
            <div class="d-flex align-items-center">
                <button class="btn btn-link sidebar-toggle me-3" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <h5 class="mb-0" id="pageTitle">Dashboard Overview</h5>
            </div>
            <div class="d-flex align-items-center">
                <span class="me-3">Welcome, <strong><%= user.first_name || user.username %></strong></span>
                <img src="https://via.placeholder.com/32x32/667eea/ffffff?text=<%= (user.first_name || user.username).charAt(0).toUpperCase() %>" 
                     class="rounded-circle" alt="Avatar">
            </div>
        </nav>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Overview Section -->
            <div id="overview-section" class="content-section">
                <!-- Stats Cards -->
                <div class="row mb-4">
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="stat-card">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-muted mb-2">Total Customers</h6>
                                    <h3 class="mb-0" id="totalCustomers">-</h3>
                                    <small class="text-muted">Active accounts</small>
                                </div>
                                <div class="stat-icon text-primary">
                                    <i class="fas fa-users"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="stat-card success">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-muted mb-2">Receipt Roll Users</h6>
                                    <h3 class="mb-0" id="receiptRollCustomers">-</h3>
                                    <small class="text-muted">Target customers</small>
                                </div>
                                <div class="stat-icon text-success">
                                    <i class="fas fa-receipt"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="stat-card warning">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-muted mb-2">Calls (30 days)</h6>
                                    <h3 class="mb-0" id="totalCalls">-</h3>
                                    <small class="text-muted"><span id="callSuccessRate">-</span>% success rate</small>
                                </div>
                                <div class="stat-icon text-warning">
                                    <i class="fas fa-phone"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="stat-card info">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-muted mb-2">Revenue (30 days)</h6>
                                    <h3 class="mb-0" id="totalRevenue">-</h3>
                                    <small class="text-muted"><span id="totalOrders">-</span> orders</small>
                                </div>
                                <div class="stat-icon text-info">
                                    <i class="fas fa-euro-sign"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activities -->
                <div class="row">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Recent Activities</h5>
                            </div>
                            <div class="card-body">
                                <div id="recentActivities">
                                    <div class="loading">
                                        <i class="fas fa-spinner fa-spin"></i> Loading activities...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-tasks me-2"></i>Quick Actions</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary" onclick="showSection('customers')">
                                        <i class="fas fa-user-plus me-2"></i>Add Customer
                                    </button>
                                    <button class="btn btn-outline-primary" onclick="showSection('calls')">
                                        <i class="fas fa-phone-plus me-2"></i>Log Call
                                    </button>
                                    <button class="btn btn-outline-primary" onclick="showSection('products')">
                                        <i class="fas fa-box me-2"></i>Manage Products
                                    </button>
                                    <button class="btn btn-outline-primary" onclick="downloadCustomerTemplate()">
                                        <i class="fas fa-download me-2"></i>Customer Template
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Customers Section -->
            <div id="customers-section" class="content-section" style="display: none;">
                <div class="row mb-3">
                    <div class="col-md-8">
                        <h4>Customer Management</h4>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-primary me-2" onclick="showAddCustomerModal()">
                            <i class="fas fa-user-plus me-2"></i>Add Customer
                        </button>
                        <button class="btn btn-outline-primary" onclick="showUploadModal()">
                            <i class="fas fa-upload me-2"></i>Upload CSV
                        </button>
                    </div>
                </div>

                <!-- Customer Filters -->
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <input type="text" class="form-control" id="customerSearch" placeholder="Search customers...">
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" id="statusFilter">
                                    <option value="all">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" id="receiptRollFilter">
                                    <option value="all">All Customers</option>
                                    <option value="true">Receipt Roll Users</option>
                                    <option value="false">Others</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-primary me-2" onclick="loadCustomers()">
                                    <i class="fas fa-search me-1"></i>Search
                                </button>
                                <button class="btn btn-outline-secondary" onclick="exportCustomers()">
                                    <i class="fas fa-download me-1"></i>Export
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Customers Table -->
                <div class="card">
                    <div class="card-body">
                        <div id="customersTable">
                            <div class="loading">
                                <i class="fas fa-spinner fa-spin"></i> Loading customers...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calls Section -->
            <div id="calls-section" class="content-section" style="display: none;">
                <div class="row mb-3">
                    <div class="col-md-8">
                        <h4>Call Management</h4>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-primary" onclick="showAddCallModal()">
                            <i class="fas fa-phone-plus me-2"></i>Log Call
                        </button>
                    </div>
                </div>

                <!-- Call Filters -->
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <select class="form-select" id="callDirectionFilter">
                                    <option value="all">All Directions</option>
                                    <option value="inbound">Inbound</option>
                                    <option value="outbound">Outbound</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="callStatusFilter">
                                    <option value="all">All Status</option>
                                    <option value="completed">Completed</option>
                                    <option value="missed">Missed</option>
                                    <option value="busy">Busy</option>
                                    <option value="no-answer">No Answer</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <input type="date" class="form-control" id="callStartDate">
                            </div>
                            <div class="col-md-2">
                                <input type="date" class="form-control" id="callEndDate">
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-primary w-100" onclick="loadCalls()">
                                    <i class="fas fa-search me-1"></i>Search
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Call Statistics -->
                <div class="row mb-3">
                    <div class="col-lg-3 col-md-6 mb-2">
                        <div class="card bg-primary text-white">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">Total Calls</h6>
                                        <h4 class="mb-0" id="totalCallsCount">-</h4>
                                    </div>
                                    <i class="fas fa-phone fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-2">
                        <div class="card bg-success text-white">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">Completed</h6>
                                        <h4 class="mb-0" id="completedCallsCount">-</h4>
                                    </div>
                                    <i class="fas fa-phone-check fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-2">
                        <div class="card bg-warning text-white">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">Follow-ups</h6>
                                        <h4 class="mb-0" id="followUpCallsCount">-</h4>
                                    </div>
                                    <i class="fas fa-calendar-check fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-2">
                        <div class="card bg-info text-white">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">Avg Duration</h6>
                                        <h4 class="mb-0" id="avgCallDuration">-</h4>
                                    </div>
                                    <i class="fas fa-clock fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Calls Table -->
                <div class="card">
                    <div class="card-body">
                        <div id="callsTable">
                            <div class="loading">
                                <i class="fas fa-spinner fa-spin"></i> Loading calls...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Products Section -->
            <div id="products-section" class="content-section" style="display: none;">
                <div class="row mb-3">
                    <div class="col-md-8">
                        <h4>Product Management</h4>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-primary" onclick="showAddProductModal()">
                            <i class="fas fa-plus me-2"></i>Add Product
                        </button>
                    </div>
                </div>

                <!-- Product Filters -->
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <input type="text" class="form-control" id="productSearch" placeholder="Search products by name, description, or SKU...">
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="activeFilter">
                                    <option value="all">All Products</option>
                                    <option value="true">Active Only</option>
                                    <option value="false">Inactive</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-primary me-2" onclick="loadProducts()">
                                    <i class="fas fa-search me-1"></i>Search
                                </button>
                                <button class="btn btn-outline-warning" onclick="loadLowStockProducts()">
                                    <i class="fas fa-exclamation-triangle me-1"></i>Low Stock
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Product Statistics -->
                <div class="row mb-3">
                    <div class="col-lg-3 col-md-6 mb-2">
                        <div class="card bg-primary text-white">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">Total Products</h6>
                                        <h4 class="mb-0" id="totalProductsCount">-</h4>
                                    </div>
                                    <i class="fas fa-box fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-2">
                        <div class="card bg-success text-white">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">Active Products</h6>
                                        <h4 class="mb-0" id="activeProductsCount">-</h4>
                                    </div>
                                    <i class="fas fa-check-circle fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-2">
                        <div class="card bg-warning text-white">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">Low Stock</h6>
                                        <h4 class="mb-0" id="lowStockProductsCount">-</h4>
                                    </div>
                                    <i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-2">
                        <div class="card bg-info text-white">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">Total Stock</h6>
                                        <h4 class="mb-0" id="totalStockCount">-</h4>
                                    </div>
                                    <i class="fas fa-warehouse fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Products Table -->
                <div class="card">
                    <div class="card-body">
                        <div id="productsTable">
                            <div class="loading">
                                <i class="fas fa-spinner fa-spin"></i> Loading products...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Orders Section -->
            <div id="orders-section" class="content-section" style="display: none;">
                <div class="row mb-3">
                    <div class="col-md-12">
                        <h4>Order Management</h4>
                        <p class="text-muted">Orders are automatically synced from Shopify</p>
                    </div>
                </div>

                <!-- Order Filters -->
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <select class="form-select" id="orderStatusFilter">
                                    <option value="all">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="confirmed">Confirmed</option>
                                    <option value="processing">Processing</option>
                                    <option value="shipped">Shipped</option>
                                    <option value="delivered">Delivered</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <input type="date" class="form-control" id="orderStartDate">
                            </div>
                            <div class="col-md-2">
                                <input type="date" class="form-control" id="orderEndDate">
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-primary w-100" onclick="loadOrders()">
                                    <i class="fas fa-search me-1"></i>Search
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Statistics -->
                <div class="row mb-3">
                    <div class="col-lg-3 col-md-6 mb-2">
                        <div class="card bg-primary text-white">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">Total Orders</h6>
                                        <h4 class="mb-0" id="totalOrdersCount">-</h4>
                                    </div>
                                    <i class="fas fa-shopping-cart fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-2">
                        <div class="card bg-warning text-white">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">Pending</h6>
                                        <h4 class="mb-0" id="pendingOrdersCount">-</h4>
                                    </div>
                                    <i class="fas fa-clock fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-2">
                        <div class="card bg-success text-white">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">Delivered</h6>
                                        <h4 class="mb-0" id="deliveredOrdersCount">-</h4>
                                    </div>
                                    <i class="fas fa-check-circle fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-2">
                        <div class="card bg-info text-white">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">Revenue</h6>
                                        <h4 class="mb-0" id="totalRevenueMoney">-</h4>
                                    </div>
                                    <i class="fas fa-euro-sign fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Orders Table -->
                <div class="card">
                    <div class="card-body">
                        <div id="ordersTable">
                            <div class="loading">
                                <i class="fas fa-spinner fa-spin"></i> Loading orders...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Section -->
            <div id="analytics-section" class="content-section" style="display: none;">
                <h4>Analytics & Reports</h4>
                <div class="row">
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">Sales Overview</div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-6">
                                        <div class="text-center">
                                            <h3 class="text-primary" id="analyticsRevenue">â‚¬0</h3>
                                            <p class="text-muted">Total Revenue</p>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="text-center">
                                            <h3 class="text-success" id="analyticsOrders">0</h3>
                                            <p class="text-muted">Total Orders</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">Customer Metrics</div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-6">
                                        <div class="text-center">
                                            <h3 class="text-info" id="analyticsCustomers">0</h3>
                                            <p class="text-muted">Total Customers</p>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="text-center">
                                            <h3 class="text-warning" id="analyticsCalls">0</h3>
                                            <p class="text-muted">Total Calls</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settings-section" class="content-section" style="display: none;">
                <h4>Settings</h4>
                <div class="row">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">User Profile</div>
                            <div class="card-body">
                                <form id="userProfileForm">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">First Name</label>
                                                <input type="text" class="form-control" id="settingsFirstName" value="<%= user.first_name || '' %>">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Last Name</label>
                                                <input type="text" class="form-control" id="settingsLastName" value="<%= user.last_name || '' %>">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Email</label>
                                        <input type="email" class="form-control" id="settingsEmail" value="<%= user.email || '' %>">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Username</label>
                                        <input type="text" class="form-control" id="settingsUsername" value="<%= user.username || '' %>" readonly>
                                        <small class="text-muted">Username cannot be changed</small>
                                    </div>
                                    <button type="button" class="btn btn-primary" onclick="updateProfile()">
                                        <i class="fas fa-save me-2"></i>Save Changes
                                    </button>
                                </form>
                            </div>
                        </div>
                        
                        <!-- Change Password Card -->
                        <div class="card mt-4">
                            <div class="card-header">Change Password</div>
                            <div class="card-body">
                                <form id="changePasswordForm">
                                    <div class="mb-3">
                                        <label class="form-label">New Password *</label>
                                        <input type="password" class="form-control" id="newPassword" required minlength="6">
                                        <small class="text-muted">Password must be at least 6 characters long</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Confirm New Password *</label>
                                        <input type="password" class="form-control" id="confirmPassword" required minlength="6">
                                    </div>
                                    <button type="button" class="btn btn-warning" onclick="changePassword()">
                                        <i class="fas fa-key me-2"></i>Change Password
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">Quick Actions</div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-primary" onclick="downloadCustomerTemplate()">
                                        <i class="fas fa-download me-2"></i>Download Template
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="exportCustomers()">
                                        <i class="fas fa-file-export me-2"></i>Export Data
                                    </button>
                                    <button class="btn btn-outline-info" onclick="showSystemInfo()">
                                        <i class="fas fa-info-circle me-2"></i>System Info
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Customer Modal -->
    <div class="modal fade" id="addCustomerModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Customer</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addCustomerForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Company Name *</label>
                                    <input type="text" class="form-control" name="company_name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Contact Person</label>
                                    <input type="text" class="form-control" name="contact_person">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" name="email">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Phone</label>
                                    <input type="tel" class="form-control" name="phone">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Mobile</label>
                                    <input type="tel" class="form-control" name="mobile">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">VAT Number</label>
                                    <input type="text" class="form-control" name="vat_number">
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="uses_receipt_rolls" id="usesReceiptRolls">
                                <label class="form-check-label" for="usesReceiptRolls">
                                    Uses Receipt Rolls
                                </label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="opt_out" id="optOut">
                                <label class="form-check-label" for="optOut">
                                    <span class="text-danger">Opt Out</span> - Customer cannot be contacted
                                </label>
                            </div>
                        </div>

                        <h6 class="mb-3">Invoice Address</h6>
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label class="form-label">Street</label>
                                    <input type="text" class="form-control" name="invoice_address_street">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Number</label>
                                    <input type="text" class="form-control" name="invoice_address_number">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Postal Code</label>
                                    <input type="text" class="form-control" name="invoice_address_postal_code">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">City</label>
                                    <input type="text" class="form-control" name="invoice_address_city">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Country</label>
                                    <input type="text" class="form-control" name="invoice_address_country" value="Belgium">
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="delivery_same_as_invoice" id="deliverySameAsInvoice" checked>
                                <label class="form-check-label" for="deliverySameAsInvoice">
                                    Delivery address same as invoice address
                                </label>
                            </div>
                        </div>

                        <div id="deliveryAddressSection" style="display: none;">
                            <h6 class="mb-3">Delivery Address</h6>
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label class="form-label">Street</label>
                                        <input type="text" class="form-control" name="delivery_address_street">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Number</label>
                                        <input type="text" class="form-control" name="delivery_address_number">
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Postal Code</label>
                                        <input type="text" class="form-control" name="delivery_address_postal_code">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">City</label>
                                        <input type="text" class="form-control" name="delivery_address_city">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Country</label>
                                        <input type="text" class="form-control" name="delivery_address_country" value="Belgium">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Notes</label>
                            <textarea class="form-control" name="notes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveCustomer()">
                        <i class="fas fa-save me-2"></i>Save Customer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Customer Modal -->
    <div class="modal fade" id="editCustomerModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Customer</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editCustomerForm">
                        <input type="hidden" id="editCustomerId" name="customer_id">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Company Name *</label>
                                    <input type="text" class="form-control" name="company_name" id="editCompanyName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Contact Person</label>
                                    <input type="text" class="form-control" name="contact_person" id="editContactPerson">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" name="email" id="editEmail">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Phone</label>
                                    <input type="tel" class="form-control" name="phone" id="editPhone">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Mobile</label>
                                    <input type="tel" class="form-control" name="mobile" id="editMobile">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">VAT Number</label>
                                    <input type="text" class="form-control" name="vat_number" id="editVatNumber">
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="uses_receipt_rolls" id="editUsesReceiptRolls">
                                <label class="form-check-label" for="editUsesReceiptRolls">
                                    Uses Receipt Rolls
                                </label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="opt_out" id="editOptOut">
                                <label class="form-check-label" for="editOptOut">
                                    <span class="text-danger">Opt Out</span> - Customer cannot be contacted
                                </label>
                            </div>
                        </div>

                        <h6 class="mb-3">Invoice Address</h6>
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label class="form-label">Street</label>
                                    <input type="text" class="form-control" name="invoice_address_street" id="editInvoiceStreet">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Number</label>
                                    <input type="text" class="form-control" name="invoice_address_number" id="editInvoiceNumber">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Postal Code</label>
                                    <input type="text" class="form-control" name="invoice_address_postal_code" id="editInvoicePostalCode">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">City</label>
                                    <input type="text" class="form-control" name="invoice_address_city" id="editInvoiceCity">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Country</label>
                                    <input type="text" class="form-control" name="invoice_address_country" id="editInvoiceCountry">
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Notes</label>
                            <textarea class="form-control" name="notes" id="editNotes" rows="3"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" name="status" id="editStatus">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateCustomer()">
                        <i class="fas fa-save me-2"></i>Update Customer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Call Modal -->
    <div class="modal fade" id="addCallModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Log New Call</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addCallForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Customer</label>
                                    <select class="form-select" name="customer_id" id="callCustomer">
                                        <option value="">Select Customer (Optional)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Phone Number *</label>
                                    <input type="tel" class="form-control" name="phone_number" required>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Direction *</label>
                                    <select class="form-select" name="direction" required>
                                        <option value="">Select Direction</option>
                                        <option value="inbound">Inbound</option>
                                        <option value="outbound">Outbound</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Status *</label>
                                    <select class="form-select" name="status" required>
                                        <option value="">Select Status</option>
                                        <option value="completed">Completed</option>
                                        <option value="missed">Missed</option>
                                        <option value="busy">Busy</option>
                                        <option value="no-answer">No Answer</option>
                                        <option value="voicemail">Voicemail</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Duration (seconds)</label>
                                    <input type="number" class="form-control" name="duration" min="0">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Sentiment</label>
                                    <select class="form-select" name="sentiment">
                                        <option value="">Select Sentiment</option>
                                        <option value="positive">Positive</option>
                                        <option value="neutral">Neutral</option>
                                        <option value="negative">Negative</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Recording URL</label>
                                    <input type="url" class="form-control" name="recording_url">
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="follow_up_required" id="followUpRequired">
                                <label class="form-check-label" for="followUpRequired">
                                    Follow-up required
                                </label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">AI Summary / Notes</label>
                            <textarea class="form-control" name="ai_summary" rows="4" placeholder="Enter call summary or notes..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveCall()">
                        <i class="fas fa-save me-2"></i>Save Call
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Product Modal -->
    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalTitle">Add New Product</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <input type="hidden" id="productId" name="product_id">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Product Name *</label>
                                    <input type="text" class="form-control" name="name" id="productName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">SKU *</label>
                                    <input type="text" class="form-control" name="sku" id="productSku" required placeholder="e.g. RR-80-40-12">
                                    <small class="form-text text-muted">Unique identifier for Shopify integration</small>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" name="description" id="productDescription" rows="3"></textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Price (â‚¬)</label>
                                    <input type="number" class="form-control" name="price" id="productPrice" step="0.01" min="0" readonly>
                                    <small class="form-text text-muted">Automatically synchronized from Shopify</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Stock Quantity</label>
                                    <input type="number" class="form-control" name="stock_quantity" id="productStock" min="0" readonly>
                                    <small class="form-text text-muted">Automatically synchronized from Shopify</small>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="is_active" id="productActive" checked>
                                <label class="form-check-label" for="productActive">
                                    Active Product
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveProductBtn" onclick="saveProduct()">
                        <i class="fas fa-save me-2"></i>Save Product
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload CSV Modal -->
    <div class="modal fade" id="uploadModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Upload Customer CSV</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">CSV File (European format - semicolon separated)</label>
                        <input type="file" class="form-control" id="csvFile" accept=".csv">
                        <div class="form-text">
                            Download the template to see the required format.
                        </div>
                    </div>
                    <div class="mb-3">
                        <button class="btn btn-outline-secondary btn-sm" onclick="downloadCustomerTemplate()">
                            <i class="fas fa-download me-2"></i>Download Template
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="uploadCSV()">
                        <i class="fas fa-upload me-2"></i>Upload
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delivery Addresses Modal -->
    <div class="modal fade" id="deliveryAddressesModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Delivery Addresses</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h6 id="deliveryCustomerName" class="mb-0"></h6>
                            <small class="text-muted">Manage delivery addresses for this customer</small>
                        </div>
                        <button class="btn btn-success" onclick="showAddDeliveryAddressForm()">
                            <i class="fas fa-plus me-2"></i>Add Address
                        </button>
                    </div>
                    
                    <div id="deliveryAddressesList">
                        <!-- Delivery addresses will be loaded here -->
                    </div>
                    
                    <!-- Add/Edit Delivery Address Form -->
                    <div id="deliveryAddressForm" style="display: none;">
                        <hr>
                        <h6 id="deliveryFormTitle">Add New Delivery Address</h6>
                        <form id="deliveryAddressFormData">
                            <input type="hidden" id="deliveryAddressId" name="address_id">
                            <input type="hidden" id="deliveryCustomerId" name="customer_id">
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Address Name *</label>
                                        <input type="text" class="form-control" id="deliveryAddressName" name="address_name" required>
                                        <small class="form-text text-muted">e.g., "Main Warehouse", "Store Branch 1"</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Contact Person</label>
                                        <input type="text" class="form-control" id="deliveryContactPerson" name="contact_person">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label class="form-label">Street</label>
                                        <input type="text" class="form-control" id="deliveryStreet" name="street">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Number</label>
                                        <input type="text" class="form-control" id="deliveryNumber" name="number">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">City</label>
                                        <input type="text" class="form-control" id="deliveryCity" name="city">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">Postal Code</label>
                                        <input type="text" class="form-control" id="deliveryPostalCode" name="postal_code">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">Country</label>
                                        <input type="text" class="form-control" id="deliveryCountry" name="country" value="Belgium">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Contact Phone</label>
                                        <input type="tel" class="form-control" id="deliveryContactPhone" name="contact_phone">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Contact Email</label>
                                        <input type="email" class="form-control" id="deliveryContactEmail" name="contact_email">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Notes</label>
                                <textarea class="form-control" id="deliveryNotes" name="notes" rows="2"></textarea>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="deliveryIsPrimary" name="is_primary">
                                        <label class="form-check-label" for="deliveryIsPrimary">
                                            Primary Delivery Address
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="deliveryCanPlaceOrders" name="can_place_orders">
                                        <label class="form-check-label" for="deliveryCanPlaceOrders">
                                            <strong>Can Place Orders Independently</strong>
                                        </label>
                                        <small class="form-text text-muted d-block">If unchecked, orders must be placed centrally by main contact</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-end gap-2">
                                <button type="button" class="btn btn-secondary" onclick="hideDeliveryAddressForm()">Cancel</button>
                                <button type="button" class="btn btn-success" onclick="saveDeliveryAddress()">
                                    <i class="fas fa-save me-2"></i>Save Address
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let currentSection = 'overview';
        let currentPage = 1;
        const itemsPerPage = 10;

        // Authentication helper
        function getAuthHeader() {
            const token = localStorage.getItem('auth_token');
            return token ? { 'Authorization': `Bearer ${token}` } : {};
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            const token = localStorage.getItem('auth_token');
            if (!token) {
                window.location.href = '/login';
                return;
            }

            // Load initial data
            loadDashboardStats();
            loadRecentActivities();
            
            // Setup event listeners
            setupEventListeners();
        });

        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.dataset.section;
                    showSection(section);
                });
            });

            // Customer search
            const searchInput = document.getElementById('customerSearch');
            if (searchInput) {
                searchInput.addEventListener('input', debounce(loadCustomers, 500));
            }

            // Delivery address toggle
            const deliveryCheckbox = document.getElementById('deliverySameAsInvoice');
            if (deliveryCheckbox) {
                deliveryCheckbox.addEventListener('change', function() {
                    const section = document.getElementById('deliveryAddressSection');
                    section.style.display = this.checked ? 'none' : 'block';
                });
            }
        }

        // Load dashboard statistics
        async function loadDashboardStats() {
            try {
                const response = await fetch('/api/dashboard/stats', {
                    headers: getAuthHeader()
                });
                
                if (!response.ok) throw new Error('Failed to load stats');
                
                const result = await response.json();
                const stats = result.data.overview;
                
                // Update stat cards
                document.getElementById('totalCustomers').textContent = stats.totalCustomers;
                document.getElementById('receiptRollCustomers').textContent = stats.receiptRollCustomers;
                document.getElementById('totalCalls').textContent = stats.totalCalls;
                document.getElementById('callSuccessRate').textContent = stats.callSuccessRate;
                document.getElementById('totalRevenue').textContent = `â‚¬${stats.totalRevenue.toFixed(2)}`;
                document.getElementById('totalOrders').textContent = stats.totalOrders;
                
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
                showAlert('Failed to load dashboard statistics', 'danger');
            }
        }

        // Load recent activities
        async function loadRecentActivities() {
            try {
                const response = await fetch('/api/dashboard/stats', {
                    headers: getAuthHeader()
                });
                
                if (!response.ok) throw new Error('Failed to load activities');
                
                const result = await response.json();
                const activities = result.data.recentActivities;
                
                const activitiesContainer = document.getElementById('recentActivities');
                if (activities.length === 0) {
                    activitiesContainer.innerHTML = '<p class="text-muted">No recent activities</p>';
                    return;
                }

                const activitiesHtml = activities.map(activity => {
                    const icon = activity.type === 'call' ? 'fa-phone' : 'fa-shopping-cart';
                    const color = activity.status === 'completed' ? 'success' : 
                                 activity.status === 'pending' ? 'warning' : 'info';
                    
                    return `
                        <div class="d-flex align-items-center mb-3">
                            <div class="me-3">
                                <i class="fas ${icon} text-${color}"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1">${activity.title || 'Unknown'}</h6>
                                <small class="text-muted">
                                    ${activity.type === 'call' ? 'Call' : 'Order'} - 
                                    ${new Date(activity.created_at).toLocaleDateString()}
                                </small>
                            </div>
                            <span class="badge bg-${color}">${activity.status}</span>
                        </div>
                    `;
                }).join('');

                activitiesContainer.innerHTML = activitiesHtml;
                
            } catch (error) {
                console.error('Error loading recent activities:', error);
                document.getElementById('recentActivities').innerHTML = 
                    '<p class="text-muted">Failed to load activities</p>';
            }
        }

        // Show specific section
        function showSection(section) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(sec => {
                sec.style.display = 'none';
            });

            // Show selected section
            document.getElementById(`${section}-section`).style.display = 'block';

            // Update navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`[data-section="${section}"]`).classList.add('active');

            // Update page title
            const titles = {
                overview: 'Dashboard Overview',
                customers: 'Customer Management',
                calls: 'Call Management',
                products: 'Product Management',
                orders: 'Order Management',
                analytics: 'Analytics & Reports',
                settings: 'Settings'
            };
            document.getElementById('pageTitle').textContent = titles[section] || 'Dashboard';

            currentSection = section;

            // Load section-specific data
            if (section === 'customers') {
                loadCustomers();
            } else if (section === 'calls') {
                loadCalls();
                loadCallStats();
            } else if (section === 'products') {
                loadProducts();
                loadProductStats();
            } else if (section === 'orders') {
                loadOrders();
                loadOrderStats();
            } else if (section === 'analytics') {
                loadAnalytics();
            }
        }

        // Load customers
        async function loadCustomers() {
            try {
                const searchTerm = document.getElementById('customerSearch')?.value || '';
                const statusFilter = document.getElementById('statusFilter')?.value || 'all';
                const receiptRollFilter = document.getElementById('receiptRollFilter')?.value || 'all';

                const params = new URLSearchParams({
                    page: currentPage,
                    limit: itemsPerPage,
                    search: searchTerm,
                    status: statusFilter,
                    uses_receipt_rolls: receiptRollFilter
                });

                const response = await fetch(`/api/customers?${params}`, {
                    headers: getAuthHeader()
                });

                if (!response.ok) throw new Error('Failed to load customers');

                const result = await response.json();
                displayCustomers(result.data);

            } catch (error) {
                console.error('Error loading customers:', error);
                showAlert('Failed to load customers', 'danger');
            }
        }

        // Display customers table
        function displayCustomers(data) {
            const container = document.getElementById('customersTable');
            
            if (data.customers.length === 0) {
                container.innerHTML = '<p class="text-muted">No customers found</p>';
                return;
            }

            const tableHtml = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Company</th>
                                <th>Contact</th>
                                <th>Phone</th>
                                <th>Receipt Rolls</th>
                                <th>Opt Out</th>
                                <th>City</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.customers.map(customer => `
                                <tr>
                                    <td>
                                        <strong>${customer.company_name}</strong>
                                        ${customer.vat_number ? `<br><small class="text-muted">${customer.vat_number}</small>` : ''}
                                    </td>
                                    <td>
                                        ${customer.contact_person || '-'}
                                        ${customer.email ? `<br><small class="text-muted">${customer.email}</small>` : ''}
                                    </td>
                                    <td>
                                        ${customer.phone || '-'}
                                        ${customer.mobile ? `<br><small class="text-muted">${customer.mobile}</small>` : ''}
                                    </td>
                                    <td>
                                        <span class="badge ${customer.uses_receipt_rolls ? 'bg-success' : 'bg-secondary'}">
                                            ${customer.uses_receipt_rolls ? 'Yes' : 'No'}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge ${customer.opt_out ? 'bg-danger' : 'bg-success'}">
                                            ${customer.opt_out ? 'Yes' : 'No'}
                                        </span>
                                    </td>
                                    <td>${customer.invoice_address_city || '-'}</td>
                                    <td>
                                        <span class="badge ${customer.status === 'active' ? 'bg-success' : 'bg-secondary'}">
                                            ${customer.status}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-info" onclick="manageDeliveryAddresses(${customer.id}, '${customer.company_name}')" title="Delivery Addresses">
                                                <i class="fas fa-map-marker-alt"></i>
                                            </button>
                                            <button class="btn btn-outline-primary" onclick="editCustomer(${customer.id})" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-outline-danger" onclick="deleteCustomer(${customer.id})" title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                
                ${data.pagination.totalPages > 1 ? `
                    <nav aria-label="Customer pagination">
                        <ul class="pagination justify-content-center">
                            <li class="page-item ${!data.pagination.hasPrev ? 'disabled' : ''}">
                                <a class="page-link" href="#" onclick="changePage(${data.pagination.currentPage - 1})">Previous</a>
                            </li>
                            ${Array.from({ length: data.pagination.totalPages }, (_, i) => i + 1)
                                .map(page => `
                                    <li class="page-item ${page === data.pagination.currentPage ? 'active' : ''}">
                                        <a class="page-link" href="#" onclick="changePage(${page})">${page}</a>
                                    </li>
                                `).join('')}
                            <li class="page-item ${!data.pagination.hasNext ? 'disabled' : ''}">
                                <a class="page-link" href="#" onclick="changePage(${data.pagination.currentPage + 1})">Next</a>
                            </li>
                        </ul>
                    </nav>
                ` : ''}
            `;

            container.innerHTML = tableHtml;
        }

        // Modal functions
        function showAddCustomerModal() {
            const modal = new bootstrap.Modal(document.getElementById('addCustomerModal'));
            modal.show();
        }

        function showUploadModal() {
            const modal = new bootstrap.Modal(document.getElementById('uploadModal'));
            modal.show();
        }

        // Save customer
        async function saveCustomer() {
            try {
                const form = document.getElementById('addCustomerForm');
                const formData = new FormData(form);
                
                const customerData = {
                    company_name: formData.get('company_name'),
                    contact_person: formData.get('contact_person'),
                    email: formData.get('email'),
                    phone: formData.get('phone'),
                    mobile: formData.get('mobile'),
                    vat_number: formData.get('vat_number'),
                    uses_receipt_rolls: formData.has('uses_receipt_rolls'),
                    opt_out: formData.has('opt_out'),
                    invoice_address_street: formData.get('invoice_address_street'),
                    invoice_address_number: formData.get('invoice_address_number'),
                    invoice_address_city: formData.get('invoice_address_city'),
                    invoice_address_postal_code: formData.get('invoice_address_postal_code'),
                    invoice_address_country: formData.get('invoice_address_country'),
                    delivery_same_as_invoice: formData.has('delivery_same_as_invoice'),
                    notes: formData.get('notes')
                };

                // Add delivery address if different
                if (!customerData.delivery_same_as_invoice) {
                    customerData.delivery_addresses = [{
                        street: formData.get('delivery_address_street'),
                        number: formData.get('delivery_address_number'),
                        city: formData.get('delivery_address_city'),
                        postal_code: formData.get('delivery_address_postal_code'),
                        country: formData.get('delivery_address_country')
                    }];
                }

                const response = await fetch('/api/customers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeader()
                    },
                    body: JSON.stringify(customerData)
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('Customer created successfully', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addCustomerModal')).hide();
                    form.reset();
                    loadCustomers();
                } else {
                    showAlert(result.error || 'Failed to create customer', 'danger');
                }

            } catch (error) {
                console.error('Error saving customer:', error);
                showAlert('Failed to save customer', 'danger');
            }
        }

        // Download customer template
        function downloadCustomerTemplate() {
            const link = document.createElement('a');
            link.href = '/api/customers/download/template';
            link.download = 'customers_template.csv';
            link.click();
        }

        // Upload CSV
        async function uploadCSV() {
            try {
                const fileInput = document.getElementById('csvFile');
                const file = fileInput.files[0];

                if (!file) {
                    showAlert('Please select a CSV file', 'warning');
                    return;
                }

                const formData = new FormData();
                formData.append('csvFile', file);

                const response = await fetch('/api/customers/upload/csv', {
                    method: 'POST',
                    headers: getAuthHeader(),
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showAlert(result.message, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide();
                    loadCustomers();
                } else {
                    showAlert(result.error || 'Upload failed', 'danger');
                }

            } catch (error) {
                console.error('Error uploading CSV:', error);
                showAlert('Failed to upload CSV file', 'danger');
            }
        }

        // Export customers
        function exportCustomers() {
            const link = document.createElement('a');
            link.href = '/api/customers/export/csv';
            link.download = `customers_export_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // Edit customer
        async function editCustomer(id) {
            try {
                // Fetch customer data
                const response = await fetch(`/api/customers/${id}`, {
                    headers: getAuthHeader()
                });

                if (!response.ok) throw new Error('Failed to load customer');

                const result = await response.json();
                const customer = result.data;

                // Populate form with customer data
                document.getElementById('editCustomerId').value = customer.id;
                document.getElementById('editCompanyName').value = customer.company_name || '';
                document.getElementById('editContactPerson').value = customer.contact_person || '';
                document.getElementById('editEmail').value = customer.email || '';
                document.getElementById('editPhone').value = customer.phone || '';
                document.getElementById('editMobile').value = customer.mobile || '';
                document.getElementById('editVatNumber').value = customer.vat_number || '';
                document.getElementById('editUsesReceiptRolls').checked = customer.uses_receipt_rolls || false;
                document.getElementById('editOptOut').checked = customer.opt_out || false;
                document.getElementById('editInvoiceStreet').value = customer.invoice_address_street || '';
                document.getElementById('editInvoiceNumber').value = customer.invoice_address_number || '';
                document.getElementById('editInvoicePostalCode').value = customer.invoice_address_postal_code || '';
                document.getElementById('editInvoiceCity').value = customer.invoice_address_city || '';
                document.getElementById('editInvoiceCountry').value = customer.invoice_address_country || 'Belgium';
                document.getElementById('editNotes').value = customer.notes || '';
                document.getElementById('editStatus').value = customer.status || 'active';

                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('editCustomerModal'));
                modal.show();

            } catch (error) {
                console.error('Error loading customer for edit:', error);
                showAlert('Failed to load customer data', 'danger');
            }
        }

        // Update customer
        async function updateCustomer() {
            try {
                const form = document.getElementById('editCustomerForm');
                const formData = new FormData(form);
                const customerId = formData.get('customer_id');
                
                const customerData = {
                    company_name: formData.get('company_name'),
                    contact_person: formData.get('contact_person'),
                    email: formData.get('email'),
                    phone: formData.get('phone'),
                    mobile: formData.get('mobile'),
                    vat_number: formData.get('vat_number'),
                    uses_receipt_rolls: formData.has('uses_receipt_rolls'),
                    opt_out: formData.has('opt_out'),
                    invoice_address_street: formData.get('invoice_address_street'),
                    invoice_address_number: formData.get('invoice_address_number'),
                    invoice_address_city: formData.get('invoice_address_city'),
                    invoice_address_postal_code: formData.get('invoice_address_postal_code'),
                    invoice_address_country: formData.get('invoice_address_country'),
                    notes: formData.get('notes'),
                    status: formData.get('status')
                };

                const response = await fetch(`/api/customers/${customerId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeader()
                    },
                    body: JSON.stringify(customerData)
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('Customer updated successfully', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('editCustomerModal')).hide();
                    loadCustomers();
                } else {
                    showAlert(result.error || 'Failed to update customer', 'danger');
                }

            } catch (error) {
                console.error('Error updating customer:', error);
                showAlert('Failed to update customer', 'danger');
            }
        }

        // Delete customer
        async function deleteCustomer(id) {
            if (!confirm('Are you sure you want to delete this customer?')) {
                return;
            }

            try {
                const response = await fetch(`/api/customers/${id}`, {
                    method: 'DELETE',
                    headers: getAuthHeader()
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('Customer deleted successfully', 'success');
                    loadCustomers();
                } else {
                    showAlert(result.error || 'Failed to delete customer', 'danger');
                }

            } catch (error) {
                console.error('Error deleting customer:', error);
                showAlert('Failed to delete customer', 'danger');
            }
        }

        // ==================== DELIVERY ADDRESS MANAGEMENT ====================

        // Manage delivery addresses for a customer
        async function manageDeliveryAddresses(customerId, customerName) {
            try {
                document.getElementById('deliveryCustomerName').textContent = customerName;
                document.getElementById('deliveryCustomerId').value = customerId;
                
                // Load delivery addresses
                await loadDeliveryAddresses(customerId);
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('deliveryAddressesModal'));
                modal.show();
                
            } catch (error) {
                console.error('Error loading delivery addresses:', error);
                showAlert('Failed to load delivery addresses', 'danger');
            }
        }

        // Load delivery addresses for a customer
        async function loadDeliveryAddresses(customerId) {
            try {
                const response = await fetch(`/api/customers/${customerId}/delivery-addresses`, {
                    headers: getAuthHeader()
                });

                if (!response.ok) throw new Error('Failed to load delivery addresses');

                const result = await response.json();
                const addresses = result.data;

                const container = document.getElementById('deliveryAddressesList');
                
                if (addresses.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-map-marker-alt fa-3x mb-3"></i>
                            <p>No delivery addresses found for this customer.</p>
                            <p>Click "Add Address" to create the first delivery address.</p>
                        </div>
                    `;
                    return;
                }

                const addressesHtml = addresses.map(address => `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="card-title mb-1">
                                        ${address.address_name}
                                        ${address.is_primary ? '<span class="badge bg-primary ms-2">Primary</span>' : ''}
                                        ${address.can_place_orders ? '<span class="badge bg-success ms-2">Can Order</span>' : '<span class="badge bg-secondary ms-2">Centralized Orders</span>'}
                                    </h6>
                                    <p class="card-text mb-2">
                                        <i class="fas fa-map-marker-alt me-2"></i>
                                        ${address.street} ${address.number}, ${address.city} ${address.postal_code}, ${address.country}
                                    </p>
                                    ${address.contact_person ? `<p class="card-text mb-1"><i class="fas fa-user me-2"></i>${address.contact_person}</p>` : ''}
                                    ${address.contact_phone ? `<p class="card-text mb-1"><i class="fas fa-phone me-2"></i>${address.contact_phone}</p>` : ''}
                                    ${address.contact_email ? `<p class="card-text mb-1"><i class="fas fa-envelope me-2"></i>${address.contact_email}</p>` : ''}
                                    ${address.notes ? `<p class="card-text mb-0 text-muted"><small>${address.notes}</small></p>` : ''}
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="editDeliveryAddress(${address.id})" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="deleteDeliveryAddress(${address.id})" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

                container.innerHTML = addressesHtml;

            } catch (error) {
                console.error('Error loading delivery addresses:', error);
                showAlert('Failed to load delivery addresses', 'danger');
            }
        }

        // Show add delivery address form
        function showAddDeliveryAddressForm() {
            document.getElementById('deliveryFormTitle').textContent = 'Add New Delivery Address';
            document.getElementById('deliveryAddressFormData').reset();
            document.getElementById('deliveryAddressId').value = '';
            document.getElementById('deliveryAddressForm').style.display = 'block';
            document.getElementById('deliveryAddressName').focus();
        }

        // Hide delivery address form
        function hideDeliveryAddressForm() {
            document.getElementById('deliveryAddressForm').style.display = 'none';
        }

        // Edit delivery address
        async function editDeliveryAddress(addressId) {
            try {
                // Find the address in the loaded data (we could also make an API call)
                const customerId = document.getElementById('deliveryCustomerId').value;
                const response = await fetch(`/api/customers/${customerId}/delivery-addresses`, {
                    headers: getAuthHeader()
                });

                if (!response.ok) throw new Error('Failed to load delivery address');

                const result = await response.json();
                const address = result.data.find(addr => addr.id === addressId);

                if (!address) {
                    showAlert('Delivery address not found', 'danger');
                    return;
                }

                // Populate form
                document.getElementById('deliveryFormTitle').textContent = 'Edit Delivery Address';
                document.getElementById('deliveryAddressId').value = address.id;
                document.getElementById('deliveryAddressName').value = address.address_name || '';
                document.getElementById('deliveryContactPerson').value = address.contact_person || '';
                document.getElementById('deliveryStreet').value = address.street || '';
                document.getElementById('deliveryNumber').value = address.number || '';
                document.getElementById('deliveryCity').value = address.city || '';
                document.getElementById('deliveryPostalCode').value = address.postal_code || '';
                document.getElementById('deliveryCountry').value = address.country || '';
                document.getElementById('deliveryContactPhone').value = address.contact_phone || '';
                document.getElementById('deliveryContactEmail').value = address.contact_email || '';
                document.getElementById('deliveryNotes').value = address.notes || '';
                document.getElementById('deliveryIsPrimary').checked = address.is_primary || false;
                document.getElementById('deliveryCanPlaceOrders').checked = address.can_place_orders || false;

                // Show form
                document.getElementById('deliveryAddressForm').style.display = 'block';

            } catch (error) {
                console.error('Error loading delivery address for edit:', error);
                showAlert('Failed to load delivery address', 'danger');
            }
        }

        // Save delivery address
        async function saveDeliveryAddress() {
            try {
                const form = document.getElementById('deliveryAddressFormData');
                const formData = new FormData(form);
                const customerId = document.getElementById('deliveryCustomerId').value;
                const addressId = document.getElementById('deliveryAddressId').value;

                const addressData = {
                    address_name: formData.get('address_name'),
                    contact_person: formData.get('contact_person'),
                    street: formData.get('street'),
                    number: formData.get('number'),
                    city: formData.get('city'),
                    postal_code: formData.get('postal_code'),
                    country: formData.get('country'),
                    contact_phone: formData.get('contact_phone'),
                    contact_email: formData.get('contact_email'),
                    notes: formData.get('notes'),
                    is_primary: formData.has('is_primary'),
                    can_place_orders: formData.has('can_place_orders')
                };

                let url, method;
                if (addressId) {
                    // Update existing address
                    url = `/api/customers/delivery-addresses/${addressId}`;
                    method = 'PUT';
                } else {
                    // Create new address
                    url = `/api/customers/${customerId}/delivery-addresses`;
                    method = 'POST';
                }

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeader()
                    },
                    body: JSON.stringify(addressData)
                });

                const result = await response.json();

                if (result.success) {
                    showAlert(addressId ? 'Delivery address updated successfully' : 'Delivery address created successfully', 'success');
                    hideDeliveryAddressForm();
                    await loadDeliveryAddresses(customerId);
                } else {
                    showAlert(result.error || 'Failed to save delivery address', 'danger');
                }

            } catch (error) {
                console.error('Error saving delivery address:', error);
                showAlert('Failed to save delivery address', 'danger');
            }
        }

        // Delete delivery address
        async function deleteDeliveryAddress(addressId) {
            if (!confirm('Are you sure you want to delete this delivery address?')) {
                return;
            }

            try {
                const response = await fetch(`/api/customers/delivery-addresses/${addressId}`, {
                    method: 'DELETE',
                    headers: getAuthHeader()
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('Delivery address deleted successfully', 'success');
                    const customerId = document.getElementById('deliveryCustomerId').value;
                    await loadDeliveryAddresses(customerId);
                } else {
                    showAlert(result.error || 'Failed to delete delivery address', 'danger');
                }

            } catch (error) {
                console.error('Error deleting delivery address:', error);
                showAlert('Failed to delete delivery address', 'danger');
            }
        }

        // Change page
        function changePage(page) {
            currentPage = page;
            loadCustomers();
        }

        // Toggle sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            
            sidebar.classList.toggle('show');
            mainContent.classList.toggle('expanded');
        }

        // Logout
        function logout() {
            localStorage.removeItem('auth_token');
            window.location.href = '/login';
        }

        // Call Management Functions
        async function loadCalls() {
            try {
                const direction = document.getElementById('callDirectionFilter')?.value || 'all';
                const status = document.getElementById('callStatusFilter')?.value || 'all';
                const startDate = document.getElementById('callStartDate')?.value || '';
                const endDate = document.getElementById('callEndDate')?.value || '';

                const params = new URLSearchParams({
                    page: 1,
                    limit: 20,
                    direction: direction,
                    status: status,
                    start_date: startDate,
                    end_date: endDate
                });

                const response = await fetch(`/api/calls?${params}`, {
                    headers: getAuthHeader()
                });

                if (!response.ok) throw new Error('Failed to load calls');

                const result = await response.json();
                displayCalls(result.data);

            } catch (error) {
                console.error('Error loading calls:', error);
                showAlert('Failed to load calls', 'danger');
            }
        }

        async function loadCallStats() {
            try {
                const response = await fetch('/api/calls/stats/summary', {
                    headers: getAuthHeader()
                });

                if (!response.ok) throw new Error('Failed to load call stats');

                const result = await response.json();
                const stats = result.data.summary;

                document.getElementById('totalCallsCount').textContent = stats.total_calls || '0';
                document.getElementById('completedCallsCount').textContent = stats.completed_calls || '0';
                document.getElementById('followUpCallsCount').textContent = stats.follow_up_required || '0';
                
                const avgDuration = stats.avg_duration ? Math.round(stats.avg_duration / 60) : 0;
                document.getElementById('avgCallDuration').textContent = `${avgDuration}m`;

            } catch (error) {
                console.error('Error loading call stats:', error);
            }
        }

        function displayCalls(data) {
            const container = document.getElementById('callsTable');
            
            if (data.calls.length === 0) {
                container.innerHTML = '<p class="text-muted">No calls found</p>';
                return;
            }

            const tableHtml = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date/Time</th>
                                <th>Customer</th>
                                <th>Phone</th>
                                <th>Direction</th>
                                <th>Duration</th>
                                <th>Status</th>
                                <th>Sentiment</th>
                                <th>Follow-up</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.calls.map(call => {
                                const date = new Date(call.created_at).toLocaleString();
                                const duration = call.duration ? `${Math.floor(call.duration / 60)}:${String(call.duration % 60).padStart(2, '0')}` : '-';
                                const customer = call.company_name || 'Unknown';
                                
                                const directionIcon = call.direction === 'inbound' ? 'fa-phone' : 'fa-phone-volume';
                                const directionColor = call.direction === 'inbound' ? 'text-success' : 'text-primary';
                                
                                const statusColor = 
                                    call.status === 'completed' ? 'bg-success' :
                                    call.status === 'missed' ? 'bg-danger' :
                                    call.status === 'busy' ? 'bg-warning' : 'bg-secondary';

                                const sentimentColor = 
                                    call.sentiment === 'positive' ? 'text-success' :
                                    call.sentiment === 'negative' ? 'text-danger' : 'text-muted';

                                const optOutWarning = call.opt_out ? '<i class="fas fa-ban text-danger" title="Customer opted out"></i> ' : '';

                                return `
                                    <tr>
                                        <td>
                                            <small>${date}</small>
                                        </td>
                                        <td>
                                            ${optOutWarning}<strong>${customer}</strong>
                                            ${call.contact_person ? `<br><small class="text-muted">${call.contact_person}</small>` : ''}
                                        </td>
                                        <td>${call.phone_number}</td>
                                        <td>
                                            <i class="fas ${directionIcon} ${directionColor} me-1"></i>
                                            ${call.direction}
                                        </td>
                                        <td>${duration}</td>
                                        <td>
                                            <span class="badge ${statusColor}">${call.status}</span>
                                        </td>
                                        <td>
                                            ${call.sentiment ? `<span class="${sentimentColor}">${call.sentiment}</span>` : '-'}
                                        </td>
                                        <td>
                                            ${call.follow_up_required ? '<i class="fas fa-flag text-warning"></i>' : '-'}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-primary" onclick="viewCall(${call.id})" title="View Details">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-outline-danger" onclick="deleteCall(${call.id})" title="Delete">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = tableHtml;
        }

        async function showAddCallModal() {
            // Load customers for dropdown
            try {
                const response = await fetch('/api/customers?limit=1000', {
                    headers: getAuthHeader()
                });

                if (response.ok) {
                    const result = await response.json();
                    const customerSelect = document.getElementById('callCustomer');
                    customerSelect.innerHTML = '<option value="">Select Customer (Optional)</option>';
                    
                    result.data.customers.forEach(customer => {
                        const option = document.createElement('option');
                        option.value = customer.id;
                        option.textContent = `${customer.company_name}${customer.contact_person ? ' - ' + customer.contact_person : ''}`;
                        option.dataset.phone = customer.phone || customer.mobile || '';
                        if (customer.opt_out) {
                            option.textContent += ' (Opted Out)';
                            option.style.color = 'red';
                        }
                        customerSelect.appendChild(option);
                    });

                    // Auto-fill phone number when customer is selected
                    customerSelect.addEventListener('change', function() {
                        const selectedOption = this.options[this.selectedIndex];
                        const phoneInput = document.querySelector('#addCallForm input[name="phone_number"]');
                        if (selectedOption.dataset.phone) {
                            phoneInput.value = selectedOption.dataset.phone;
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading customers:', error);
            }

            const modal = new bootstrap.Modal(document.getElementById('addCallModal'));
            modal.show();
        }

        async function saveCall() {
            try {
                const form = document.getElementById('addCallForm');
                const formData = new FormData(form);
                
                const callData = {
                    customer_id: formData.get('customer_id') || null,
                    phone_number: formData.get('phone_number'),
                    direction: formData.get('direction'),
                    duration: parseInt(formData.get('duration')) || 0,
                    status: formData.get('status'),
                    recording_url: formData.get('recording_url') || null,
                    ai_summary: formData.get('ai_summary') || null,
                    sentiment: formData.get('sentiment') || null,
                    follow_up_required: formData.has('follow_up_required')
                };

                const response = await fetch('/api/calls', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeader()
                    },
                    body: JSON.stringify(callData)
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('Call logged successfully', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addCallModal')).hide();
                    form.reset();
                    loadCalls();
                    loadCallStats();
                } else {
                    showAlert(result.error || 'Failed to log call', 'danger');
                }

            } catch (error) {
                console.error('Error saving call:', error);
                showAlert('Failed to log call', 'danger');
            }
        }

        async function viewCall(id) {
            try {
                const response = await fetch(`/api/calls/${id}`, {
                    headers: getAuthHeader()
                });

                if (!response.ok) throw new Error('Failed to load call');

                const result = await response.json();
                const call = result.data;

                const modalHtml = `
                    <div class="modal fade" id="viewCallModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Call Details</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <strong>Date/Time:</strong><br>
                                            ${new Date(call.created_at).toLocaleString()}
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Duration:</strong><br>
                                            ${call.duration ? `${Math.floor(call.duration / 60)}:${String(call.duration % 60).padStart(2, '0')}` : 'N/A'}
                                        </div>
                                    </div>
                                    <hr>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <strong>Customer:</strong><br>
                                            ${call.company_name || 'Unknown'}
                                            ${call.contact_person ? `<br><small>${call.contact_person}</small>` : ''}
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Phone:</strong><br>
                                            ${call.phone_number}
                                        </div>
                                    </div>
                                    <hr>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <strong>Direction:</strong><br>
                                            <span class="badge ${call.direction === 'inbound' ? 'bg-success' : 'bg-primary'}">${call.direction}</span>
                                        </div>
                                        <div class="col-md-4">
                                            <strong>Status:</strong><br>
                                            <span class="badge bg-info">${call.status}</span>
                                        </div>
                                        <div class="col-md-4">
                                            <strong>Sentiment:</strong><br>
                                            ${call.sentiment ? `<span class="badge bg-secondary">${call.sentiment}</span>` : 'N/A'}
                                        </div>
                                    </div>
                                    ${call.follow_up_required ? '<hr><div class="alert alert-warning"><i class="fas fa-flag me-2"></i>Follow-up required</div>' : ''}
                                    ${call.ai_summary ? `<hr><div><strong>Summary/Notes:</strong><br><p>${call.ai_summary}</p></div>` : ''}
                                    ${call.recording_url ? `<hr><div><strong>Recording:</strong><br><a href="${call.recording_url}" target="_blank" class="btn btn-outline-primary btn-sm"><i class="fas fa-play me-2"></i>Play Recording</a></div>` : ''}
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Remove existing modal if any
                const existingModal = document.getElementById('viewCallModal');
                if (existingModal) {
                    existingModal.remove();
                }

                // Add modal to body
                document.body.insertAdjacentHTML('beforeend', modalHtml);

                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('viewCallModal'));
                modal.show();

                // Remove modal from DOM when hidden
                modal._element.addEventListener('hidden.bs.modal', function () {
                    this.remove();
                });

            } catch (error) {
                console.error('Error loading call details:', error);
                showAlert('Failed to load call details', 'danger');
            }
        }

        async function deleteCall(id) {
            if (!confirm('Are you sure you want to delete this call log?')) {
                return;
            }

            try {
                const response = await fetch(`/api/calls/${id}`, {
                    method: 'DELETE',
                    headers: getAuthHeader()
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('Call deleted successfully', 'success');
                    loadCalls();
                    loadCallStats();
                } else {
                    showAlert(result.error || 'Failed to delete call', 'danger');
                }

            } catch (error) {
                console.error('Error deleting call:', error);
                showAlert('Failed to delete call', 'danger');
            }
        }

        // Product Management Functions
        async function loadProducts() {
            try {
                const search = document.getElementById('productSearch')?.value || '';
                const activeOnly = document.getElementById('activeFilter')?.value || 'all';

                const params = new URLSearchParams({
                    page: 1,
                    limit: 50,
                    search: search,
                    active_only: activeOnly
                });

                const response = await fetch(`/api/products?${params}`, {
                    headers: getAuthHeader()
                });

                if (!response.ok) throw new Error('Failed to load products');

                const result = await response.json();
                displayProducts(result.data);

            } catch (error) {
                console.error('Error loading products:', error);
                showAlert('Failed to load products', 'danger');
            }
        }

        async function loadProductStats() {
            try {
                const response = await fetch('/api/products/stats/summary', {
                    headers: getAuthHeader()
                });

                if (!response.ok) throw new Error('Failed to load product stats');

                const result = await response.json();
                const stats = result.data.summary;

                document.getElementById('totalProductsCount').textContent = stats.total_products || '0';
                document.getElementById('activeProductsCount').textContent = stats.active_products || '0';
                document.getElementById('lowStockProductsCount').textContent = stats.low_stock_products || '0';
                document.getElementById('totalStockCount').textContent = stats.total_stock || '0';

            } catch (error) {
                console.error('Error loading product stats:', error);
            }
        }

        // Removed loadProductCategories function as categories are no longer used

        function displayProducts(data) {
            const container = document.getElementById('productsTable');
            
            if (data.products.length === 0) {
                container.innerHTML = '<p class="text-muted">No products found</p>';
                return;
            }

            const tableHtml = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Product Name</th>
                                <th>SKU</th>
                                <th>Price</th>
                                <th>Stock</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.products.map(product => {
                                const stockStatus = product.stock_quantity <= 10 ? 'text-danger' : 'text-success';
                                const stockIcon = product.stock_quantity <= 10 ? 'fas fa-exclamation-triangle' : 'fas fa-check-circle';
                                
                                return `
                                    <tr>
                                        <td>
                                            <strong>${product.name}</strong>
                                            ${product.description ? `<br><small class="text-muted">${product.description.substring(0, 60)}${product.description.length > 60 ? '...' : ''}</small>` : ''}
                                        </td>
                                        <td>
                                            <code>${product.sku || 'N/A'}</code>
                                        </td>
                                        <td>
                                            <strong>${product.price ? `â‚¬${parseFloat(product.price).toFixed(2)}` : '-'}</strong>
                                            <br><small class="text-muted">From Shopify</small>
                                        </td>
                                        <td>
                                            <span class="${stockStatus}">
                                                <i class="${stockIcon} me-1"></i>
                                                ${product.stock_quantity || 0}
                                            </span>
                                            <br><small class="text-muted">From Shopify</small>
                                        </td>
                                        <td>
                                            <span class="badge ${product.is_active ? 'bg-success' : 'bg-secondary'}">
                                                ${product.is_active ? 'Active' : 'Inactive'}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-primary" onclick="editProduct(${product.id})" title="Edit">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-outline-success" onclick="syncWithShopify(${product.id})" title="Sync with Shopify">
                                                    <i class="fas fa-sync"></i>
                                                </button>
                                                <button class="btn btn-outline-danger" onclick="deleteProduct(${product.id})" title="Delete">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = tableHtml;
        }

        function showAddProductModal() {
            // Clear form
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            document.getElementById('productModalTitle').textContent = 'Add New Product';
            document.getElementById('saveProductBtn').innerHTML = '<i class="fas fa-save me-2"></i>Save Product';
            document.getElementById('productActive').checked = true;
            
            // Clear readonly fields for new products
            document.getElementById('productPrice').value = '';
            document.getElementById('productStock').value = '';

            const modal = new bootstrap.Modal(document.getElementById('productModal'));
            modal.show();
        }

        async function editProduct(id) {
            try {
                const response = await fetch(`/api/products/${id}`, {
                    headers: getAuthHeader()
                });

                if (!response.ok) throw new Error('Failed to load product');

                const result = await response.json();
                const product = result.data;

                // Populate form
                document.getElementById('productId').value = product.id;
                document.getElementById('productName').value = product.name || '';
                document.getElementById('productSku').value = product.sku || '';
                document.getElementById('productDescription').value = product.description || '';
                document.getElementById('productPrice').value = product.price || '';
                document.getElementById('productStock').value = product.stock_quantity || 0;

                document.getElementById('productActive').checked = product.is_active !== false;

                document.getElementById('productModalTitle').textContent = 'Edit Product';
                document.getElementById('saveProductBtn').innerHTML = '<i class="fas fa-save me-2"></i>Update Product';

                const modal = new bootstrap.Modal(document.getElementById('productModal'));
                modal.show();

            } catch (error) {
                console.error('Error loading product for edit:', error);
                showAlert('Failed to load product data', 'danger');
            }
        }

        async function saveProduct() {
            try {
                const form = document.getElementById('productForm');
                const formData = new FormData(form);
                const productId = formData.get('product_id');
                
                const productData = {
                    name: formData.get('name'),
                    sku: formData.get('sku'),
                    description: formData.get('description') || null,
                    is_active: formData.has('is_active')
                };

                const url = productId ? `/api/products/${productId}` : '/api/products';
                const method = productId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeader()
                    },
                    body: JSON.stringify(productData)
                });

                const result = await response.json();

                if (result.success) {
                    showAlert(`Product ${productId ? 'updated' : 'created'} successfully`, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
                    loadProducts();
                    loadProductStats();
                } else {
                    showAlert(result.error || `Failed to ${productId ? 'update' : 'create'} product`, 'danger');
                }

            } catch (error) {
                console.error('Error saving product:', error);
                showAlert('Failed to save product', 'danger');
            }
        }

        async function deleteProduct(id) {
            if (!confirm('Are you sure you want to delete this product?')) {
                return;
            }

            try {
                const response = await fetch(`/api/products/${id}`, {
                    method: 'DELETE',
                    headers: getAuthHeader()
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('Product deleted successfully', 'success');
                    loadProducts();
                    loadProductStats();
                } else {
                    showAlert(result.error || 'Failed to delete product', 'danger');
                }

            } catch (error) {
                console.error('Error deleting product:', error);
                showAlert('Failed to delete product', 'danger');
            }
        }

        async function syncWithShopify(id) {
            if (!confirm('Sync this product with Shopify? This will update price and stock from Shopify.')) {
                return;
            }

            try {
                // This would normally connect to Shopify API
                // For now, we'll just show that the functionality exists
                showAlert('Shopify sync functionality will be implemented with actual Shopify API integration', 'info');
                
                // Example of what the sync would do:
                // const response = await fetch(`/api/products/${id}/sync-shopify`, {
                //     method: 'PATCH',
                //     headers: {
                //         'Content-Type': 'application/json',
                //         ...getAuthHeader()
                //     },
                //     body: JSON.stringify({ 
                //         price: 12.99, // from Shopify
                //         stock_quantity: 50, // from Shopify
                //         shopify_product_id: 'shopify_123'
                //     })
                // });

            } catch (error) {
                console.error('Error syncing with Shopify:', error);
                showAlert('Failed to sync with Shopify', 'danger');
            }
        }

        async function loadLowStockProducts() {
            try {
                const response = await fetch('/api/products/stock/low', {
                    headers: getAuthHeader()
                });

                if (!response.ok) throw new Error('Failed to load low stock products');

                const result = await response.json();
                
                if (result.data.length === 0) {
                    showAlert('No low stock products found', 'info');
                    return;
                }

                displayProducts({ products: result.data });
                showAlert(`Found ${result.data.length} products with low stock`, 'warning');

            } catch (error) {
                console.error('Error loading low stock products:', error);
                showAlert('Failed to load low stock products', 'danger');
            }
        }

        // Order Management Functions (Basic Implementation)
        async function loadOrders() {
            try {
                const status = document.getElementById('orderStatusFilter')?.value || 'all';
                const startDate = document.getElementById('orderStartDate')?.value || '';
                const endDate = document.getElementById('orderEndDate')?.value || '';

                const params = new URLSearchParams({
                    page: 1,
                    limit: 20,
                    status: status,
                    start_date: startDate,
                    end_date: endDate
                });

                const response = await fetch(`/api/orders?${params}`, {
                    headers: getAuthHeader()
                });

                if (!response.ok) throw new Error('Failed to load orders');

                const result = await response.json();
                displayOrders(result.data);

            } catch (error) {
                console.error('Error loading orders:', error);
                document.getElementById('ordersTable').innerHTML = '<p class="text-muted">Failed to load orders</p>';
            }
        }

        async function loadOrderStats() {
            try {
                const response = await fetch('/api/orders/stats/summary', {
                    headers: getAuthHeader()
                });

                if (!response.ok) throw new Error('Failed to load order stats');

                const result = await response.json();
                const stats = result.data.summary;

                document.getElementById('totalOrdersCount').textContent = stats.total_orders || '0';
                document.getElementById('pendingOrdersCount').textContent = stats.pending_orders || '0';
                document.getElementById('deliveredOrdersCount').textContent = stats.delivered_orders || '0';
                document.getElementById('totalRevenueMoney').textContent = stats.total_revenue ? `â‚¬${parseFloat(stats.total_revenue).toFixed(0)}` : 'â‚¬0';

            } catch (error) {
                console.error('Error loading order stats:', error);
            }
        }

        function displayOrders(data) {
            const container = document.getElementById('ordersTable');
            
            if (data.orders.length === 0) {
                container.innerHTML = '<p class="text-muted">No orders found</p>';
                return;
            }

            const tableHtml = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Order #</th>
                                <th>Customer</th>
                                <th>Items</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.orders.map(order => {
                                const statusColors = {
                                    pending: 'bg-warning',
                                    confirmed: 'bg-info',
                                    processing: 'bg-primary',
                                    shipped: 'bg-success',
                                    delivered: 'bg-success',
                                    cancelled: 'bg-danger'
                                };

                                return `
                                    <tr>
                                        <td><strong>${order.order_number}</strong></td>
                                        <td>
                                            ${order.company_name || 'N/A'}
                                            ${order.contact_person ? `<br><small>${order.contact_person}</small>` : ''}
                                        </td>
                                        <td>${order.item_count} item(s)</td>
                                        <td>â‚¬${parseFloat(order.total_amount || 0).toFixed(2)}</td>
                                        <td>
                                            <span class="badge ${statusColors[order.status] || 'bg-secondary'}">${order.status}</span>
                                        </td>
                                        <td>${new Date(order.created_at).toLocaleDateString()}</td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-primary" onclick="viewOrder(${order.id})" title="View">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-outline-success" onclick="updateOrderStatus(${order.id}, '${order.status}')" title="Update Status">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = tableHtml;
        }

        // NOTE: Order creation removed - orders are synced from Shopify

        function viewOrder(id) {
            showAlert('View Order details will be implemented in next update', 'info');
        }

        function updateOrderStatus(id, currentStatus) {
            const statuses = ['pending', 'confirmed', 'processing', 'shipped', 'delivered', 'cancelled'];
            const newStatus = prompt(`Current status: ${currentStatus}\nEnter new status (${statuses.join(', ')}):`, currentStatus);
            
            if (newStatus && statuses.includes(newStatus)) {
                // Implementation would go here
                showAlert('Order status update will be implemented in next update', 'info');
            }
        }

        // Settings Functions
        function updateProfile() {
            showAlert('Profile update functionality will be implemented in next update', 'info');
        }

        async function changePassword() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!newPassword || !confirmPassword) {
                showAlert('Please fill in all password fields', 'error');
                return;
            }

            if (newPassword.length < 6) {
                showAlert('Password must be at least 6 characters long', 'error');
                return;
            }

            if (newPassword !== confirmPassword) {
                showAlert('Passwords do not match', 'error');
                return;
            }

            try {
                const response = await fetch('/api/auth/change-password', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeader()
                    },
                    body: JSON.stringify({
                        newPassword: newPassword
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('Password changed successfully', 'success');
                    document.getElementById('changePasswordForm').reset();
                } else {
                    showAlert(data.error || 'Failed to change password', 'error');
                }
            } catch (error) {
                console.error('Error changing password:', error);
                showAlert('Error changing password', 'error');
            }
        }

        function showSystemInfo() {
            showAlert('System: AI Sales CRM v1.0\nFeatures: Customer Management, Call Logging, Product Management, Order Management', 'info');
        }

        // Analytics Functions
        async function loadAnalytics() {
            try {
                // Load basic analytics data
                const [customersRes, ordersRes, callsRes] = await Promise.all([
                    fetch('/api/dashboard/stats', { headers: getAuthHeader() }),
                    fetch('/api/orders/stats/summary', { headers: getAuthHeader() }),
                    fetch('/api/calls/stats/summary', { headers: getAuthHeader() })
                ]);

                if (customersRes.ok) {
                    const customerData = await customersRes.json();
                    document.getElementById('analyticsCustomers').textContent = customerData.data.overview.totalCustomers || '0';
                }

                if (ordersRes.ok) {
                    const orderData = await ordersRes.json();
                    const stats = orderData.data.summary;
                    document.getElementById('analyticsRevenue').textContent = stats.total_revenue ? `â‚¬${parseFloat(stats.total_revenue).toFixed(0)}` : 'â‚¬0';
                    document.getElementById('analyticsOrders').textContent = stats.total_orders || '0';
                }

                if (callsRes.ok) {
                    const callData = await callsRes.json();
                    document.getElementById('analyticsCalls').textContent = callData.data.summary.total_calls || '0';
                }

            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        // Utility functions
        function showAlert(message, type) {
            // Create alert element
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alert);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
</body>
</html>